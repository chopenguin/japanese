<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ—¥æ–‡å–®å­— PWA</title>
    <style>
        /* --- 1. Design System & Variables --- */
        :root {
            /* JLPT Theme Colors */
            --n5-primary: #81C784; --n5-bg: #E8F5E9; --n5-text: #2E7D32;
            --n4-primary: #64B5F6; --n4-bg: #E3F2FD; --n4-text: #1565C0;
            --n3-primary: #FFB74D; --n3-bg: #FFF3E0; --n3-text: #EF6C00;
            --n2-primary: #BA68C8; --n2-bg: #F3E5F5; --n2-text: #7B1FA2;
            --n1-primary: #E57373; --n1-bg: #FFEBEE; --n1-text: #C62828;

            /* UI Base */
            --bg-body: #F7F9FC;
            --white: #FFFFFF;
            --text-main: #37474F;
            --text-sub: #90A4AE;
            --danger: #FF5252;
            --shadow: 0 4px 12px rgba(0,0,0,0.06);
            --ease: cubic-bezier(0.25, 0.8, 0.25, 1);
            
            /* Status Colors */
            --status-white: #FFFFFF;
            --status-green: #66BB6A;
            --status-yellow: #FFEE58;
            --status-master: #3cb4c9;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { margin: 0; background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* --- 2. Layout & Transitions --- */
        #app-viewport {
            width: 100%; height: 100%; max-width: 480px; margin: 0 auto;
            background: var(--bg-body); position: relative; overflow: hidden;
            display: flex; flex-direction: column; box-shadow: 0 0 40px rgba(0,0,0,0.08);
        }

        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s var(--ease);
            z-index: 10;
        }
        .page.active { transform: translateX(0); z-index: 20; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; -webkit-overflow-scrolling: touch; }

        /* --- 3. Header --- */
        header {
            padding: calc(env(safe-area-inset-top) + 12px) 20px 15px;
            background: var(--white); display: flex; align-items: center; justify-content: center;
            position: relative; z-index: 50; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            transition: background 0.3s;
        }
        /* Theme Overrides */
        .theme-n5 header { background: var(--n5-primary); }
        .theme-n4 header { background: var(--n4-primary); }
        .theme-n3 header { background: var(--n3-primary); }
        .theme-n2 header { background: var(--n2-primary); }
        .theme-n1 header { background: var(--n1-primary); }

        .header-title { font-size: 18px; font-weight: 800; letter-spacing: 0.5px; color: var(--text-main); transition: color 0.3s; }
        .theme-n5 .header-title, .theme-n4 .header-title, .theme-n3 .header-title, .theme-n2 .header-title, .theme-n1 .header-title { color: white; }

        .btn-header-icon {
            position: absolute; width: 36px; height: 36px;
            background: rgba(0,0,0,0.05); border-radius: 10px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background 0.2s;
            font-weight: 900; font-size: 18px; color: var(--text-main);
        }
        .btn-header-icon:active { background: rgba(0,0,0,0.1); }
        .btn-left { left: 15px; }
        .btn-right { right: 15px; }

        .theme-n5 .btn-header-icon, .theme-n4 .btn-header-icon, .theme-n3 .btn-header-icon, .theme-n2 .btn-header-icon, .theme-n1 .btn-header-icon { 
            background: rgba(255,255,255,0.25); color: white;
        }
        
        .btn-back::after { 
            content: ''; width: 10px; height: 10px; 
            border-top: 2px solid currentColor; border-left: 2px solid currentColor; 
            transform: rotate(-45deg) translate(2px, 2px); 
        }

        /* --- 4. Home UI --- */
        .home-grid { display: flex; flex-direction: column; gap: 14px; padding-top: 10px; }
        
        .level-card {
            height: 72px; border-radius: 18px; width: 100%;
            padding: 0 24px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: var(--shadow); cursor: pointer; position: relative; overflow: hidden;
            transition: transform 0.1s; background: white;
        }
        .level-card:active { transform: scale(0.97); }
        
        .card-n5 { background: var(--n5-bg); color: var(--n5-text); border-left: 6px solid var(--n5-primary); }
        .card-n4 { background: var(--n4-bg); color: var(--n4-text); border-left: 6px solid var(--n4-primary); }
        .card-n3 { background: var(--n3-bg); color: var(--n3-text); border-left: 6px solid var(--n3-primary); }
        .card-n2 { background: var(--n2-bg); color: var(--n2-text); border-left: 6px solid var(--n2-primary); }
        .card-n1 { background: var(--n1-bg); color: var(--n1-text); border-left: 6px solid var(--n1-primary); }
        
        .card-title { font-size: 20px; font-weight: 800; letter-spacing: 0.5px; color: var(--text-main); }

        .level-card.locked { opacity: 0.9; }
        .level-card.locked::after {
            content: 'ğŸ”’';
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(200,200,200,0.5);
            display: flex; align-items: center; justify-content: flex-end; padding-right: 30px;
            font-size: 24px; pointer-events: none;
        }

        .extra-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
        .btn-extra {
            background: white; border-radius: 16px; padding: 16px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: var(--shadow); color: var(--text-main); font-weight: 700; cursor: pointer;
        }

        /* --- 5. Map Grid --- */
        .map-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 20px 0 60px; }
        .map-dot {
            aspect-ratio: 1; border-radius: 16px; background: var(--status-white);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 800; font-size: 18px; color: #ccc;
            box-shadow: 0 4px 0 #eee; cursor: pointer; border: 2px solid #f5f5f5;
            transition: transform 0.1s;
        }
        .map-dot:active { transform: translateY(4px); box-shadow: none; }
        
        .map-dot.s-green { background: var(--status-green); color: white; box-shadow: 0 4px 0 #388E3C; border-color:transparent;}
        .map-dot.s-yellow { background: var(--status-yellow); color: #F57F17; border-color: #FBC02D; animation: pulse 2s infinite; box-shadow: 0 4px 0 #FBC02D; }
        .map-dot.s-master { background: var(--status-master); color: white; box-shadow: 0 4px 0 #0097A7; border-color:transparent;}
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- 6. Word Lists --- */
        .tab-bar { display: flex; gap: 10px; padding: 10px 20px; overflow-x: auto; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .tab-btn {
            padding: 8px 18px; border-radius: 20px; background: #f0f0f0; color: #999;
            font-weight: bold; font-size: 14px; white-space: nowrap; cursor: pointer;
        }
        .tab-btn.active { background: #333; color: white; }

        .word-list-item {
            background: white; border-bottom: 1px solid #f0f0f0; padding: 16px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .heart-icon { font-size: 22px; color: #E0E0E0; cursor: pointer; transition: 0.2s; }
        .heart-icon.active { color: #FF4081; transform: scale(1.1); }

        /* --- 7. Game UI --- */
        .game-card {
            background: white; border-radius: 24px; padding: 40px 20px; text-align: center;
            box-shadow: var(--shadow); margin: 20px 0; min-height: 240px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative;
        }
        .game-heart { position: absolute; top: 20px; right: 20px; }

        ruby { font-size: 42px; font-weight: 700; color: var(--text-main); }
        rt { font-size: 18px; color: var(--text-sub); font-weight: 500; margin-bottom: 5px; }
        .meaning-text { font-size: 22px; color: #555; margin-top: 20px; font-weight: 600; line-height: 1.4; }

        .option-btn {
            width: 100%; padding: 18px; margin-bottom: 12px; border: 2px solid #f0f0f0;
            background: white; border-radius: 16px; font-size: 17px; text-align: center;
            font-weight: 600; color: #555; transition: transform 0.1s;
            cursor: pointer;
        }
        .option-btn:active { transform: scale(0.96); }
        .option-btn.correct { background: var(--status-green); border-color: var(--status-green); color: white; }
        .option-btn.wrong { background: #FFEBEE; border-color: var(--danger); color: var(--danger); }

        /* Puzzle UI */
        .slot-box { display: flex; gap: 8px; justify-content: center; min-height: 70px; margin-bottom: 25px; border-bottom: 2px dashed #ddd; flex-wrap: wrap; padding: 10px; }
        .tile-box { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
        .tile {
            width: 48px; height: 48px; background: white; border: 1px solid #eee; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px;
            box-shadow: 0 4px 0 #ddd; cursor: pointer; transition: transform 0.1s;
        }
        .tile:active { transform: translateY(2px); box-shadow: 0 2px 0 #ddd; }
        .tile.used { opacity: 0; pointer-events: none; }
        .tile.in-slot { background: #E3F2FD; border-color: #64B5F6; box-shadow: 0 4px 0 #90CAF9; }

        /* --- 8. Modals & Settings --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s;
            display: flex; flex-direction: column; justify-content: flex-end; backdrop-filter: blur(4px);
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-center { justify-content: center; align-items: center; } 

        .bottom-sheet {
            background: white; width: 100%; border-radius: 24px 24px 0 0;
            padding: 30px 24px 40px; transform: translateY(100%); transition: transform 0.3s var(--ease);
            max-width: 480px; margin: 0 auto;
        }
        .modal-overlay.show .bottom-sheet { transform: translateY(0); }

        .dialog-box {
            background: white; width: 85%; max-width: 320px; border-radius: 20px;
            padding: 24px; transform: scale(0.9); transition: transform 0.2s var(--ease);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center;
        }
        .modal-overlay.show .dialog-box { transform: scale(1); }

        .progress-line { display: flex; justify-content: space-between; position: relative; margin: 40px 10px; }
        .progress-line::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 3px; background: #eee; z-index: 0; }
        .p-dot { 
            width: 14px; height: 14px; border-radius: 50%; background: #eee; z-index: 1; 
            border: 3px solid white; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .p-dot.filled { background: var(--status-yellow); transform: scale(1.3); } 
        .p-dot.done { background: var(--status-master); }

        /* Sliders & Buttons */
        .slider-group { margin-bottom: 25px; }
        label { font-weight: 700; font-size: 15px; color: var(--text-main); display: block; margin-bottom: 8px; }
        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: var(--text-main); margin-top: -10px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: #eee; border-radius: 3px; }

        .btn-full { width: 100%; padding: 18px; background: #333; color: white; border: none; border-radius: 16px; font-weight: bold; font-size: 16px; cursor: pointer; transition: transform 0.1s; }
        .btn-full:active { transform: scale(0.98); }
        .btn-check { background: var(--n4-primary); margin-top: 10px; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn-half { flex: 1; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; border: none; }
        .btn-cancel { background: #f0f0f0; color: #555; }
        .btn-confirm { background: var(--danger); color: white; }

        .settings-static-wrapper {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            padding-bottom: 40px;
        }
        .btn-settings-static {
            background: #f0f0f0;
            color: #555;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        /* --- NEW: Voice Selection Styles --- */
        .voice-grid { display: flex; gap: 20px; overflow-x: auto; padding: 10px 0 20px; }
        .voice-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; min-width: 70px; }
        
        .voice-avatar { 
            width: 60px; height: 60px; border-radius: 50%; background: #eee; 
            border: 3px solid transparent; display:flex; align-items:center; justify-content:center; 
            font-size:24px; color:#aaa; transition: 0.2s; 
        }
        
        .voice-name { 
            font-size: 13px; color: var(--text-main); margin-top: 8px; font-weight: bold; text-align: center;
        }
        
        /* Selected State */
        .voice-item.active .voice-avatar { 
            border-color: var(--n4-primary); background: white; 
            color: var(--n4-primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        .voice-item.active .voice-name { color: var(--n4-primary); }

    </style>
</head>
<body>

<div id="app-viewport">
    
    <!-- PAGE 1: HOME -->
    <div id="page-home" class="page active">
        <header style="background:transparent; box-shadow:none; justify-content:center;">
            <div class="header-title" style="font-size:30px; color:var(--text-main); padding-top:40px;">æ—¥æ–‡å–®å­—</div>
        </header>
        <div class="content-scroll" style="padding-top:30px;">
            <div class="home-grid">
                <!-- N5 -->
                <div class="level-card card-n5" onclick="App.goToMap('N5')">
                    <div class="card-title">JLPT N5</div>
                </div>
                <!-- N4 -->
                <div class="level-card card-n4" onclick="App.goToMap('N4')">
                    <div class="card-title">JLPT N4</div>
                </div>
                <!-- N3 -->
                <div class="level-card card-n3" onclick="App.goToMap('N3')">
                    <div class="card-title">JLPT N3</div>
                </div>
                <!-- N2 (Locked) -->
                <div class="level-card card-n2 locked" onclick="App.goToMap('N2')">
                    <div class="card-title">JLPT N2</div>
                </div>
                <!-- N1 (Locked) -->
                <div class="level-card card-n1 locked" onclick="App.goToMap('N1')">
                    <div class="card-title">JLPT N1</div>
                </div>
            </div>

            <!-- Removed Custom Flashcards Button -->

            <div class="extra-grid">
                <div class="btn-extra" onclick="App.goToLearned()">
                    <span>ğŸ“–</span> å­¸éå–®å­—
                </div>
                <div class="btn-extra" onclick="App.goToFavorites()">
                    <span>â¤ï¸</span> æœ€æ„›å–®å­—
                </div>
            </div>
            
            <div class="settings-static-wrapper">
                <div class="btn-settings-static" onclick="App.openSettings()">
                    <span>âš™ï¸</span> è¨­å®šèˆ‡å¸³è™Ÿ
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE 2: MAP -->
    <div id="page-map" class="page">
        <header>
            <div class="btn-header-icon btn-left btn-back" onclick="App.navTo('page-home')"></div>
            <div class="header-title" id="map-title">JLPT N5</div>
        </header>
        <div class="content-scroll">
            <div class="map-grid" id="map-container"></div>
        </div>
    </div>

    <!-- PAGE 3: GAME -->
    <div id="page-game" class="page">
        <header>
            <div class="btn-header-icon btn-left btn-back" onclick="App.quitGame()"></div>
            <div class="header-title" id="game-progress">1 / 30</div>
        </header>
        <div class="content-scroll" style="display:flex; flex-direction:column;">
            
            <!-- View: Preview -->
            <div id="view-preview" style="display:none; text-align:center; padding-top:20px;">
                <div style="color:var(--text-sub); font-size:14px; margin-bottom:10px;">æœ¬é—œå–®å­—é è¦½</div>
                <div class="game-card">
                    <div class="game-heart heart-icon" id="pre-heart" onclick="Game.toggleHeart()">â™¥</div>
                    <ruby><span id="pre-kanji"></span><rt id="pre-kana"></rt></ruby>
                    <div class="meaning-text" id="pre-mean"></div>
                </div>
                <button class="btn-full" onclick="Game.next()">é–‹å§‹ç·´ç¿’</button>
            </div>

            <!-- View: Quiz -->
            <div id="view-quiz" style="display:none; padding-top:20px;">
                <div class="game-card" style="min-height:200px; margin-bottom:20px;">
                     <div class="game-heart heart-icon" id="quiz-heart" onclick="Game.toggleHeart()">â™¥</div>
                     <!-- Content updated by JS (Text or Audio Icon) -->
                     <div id="quiz-q-content" style="font-size:32px; font-weight:bold; color:var(--text-main);"></div>
                     <div id="quiz-q-sub" style="font-size:16px; color:var(--text-sub); margin-top:8px;"></div>
                </div>
                <div id="quiz-options"></div>
            </div>

            <!-- View: Puzzle -->
            <div id="view-puzzle" style="display:none; padding-top:20px;">
                <div class="game-card" style="min-height:180px;">
                    <div class="game-heart heart-icon" id="puz-heart" onclick="Game.toggleHeart()">â™¥</div>
                    <div class="meaning-text" id="puz-mean" style="font-size:26px;"></div>
                    <!-- ç§»é™¤ puz-kanji é¡¯ç¤º -->
                    <div style="font-size:15px; color:#aaa; margin-top:8px;" id="puz-kanji"></div>
                </div>
                <div class="slot-box" id="puz-slots"></div>
                <div class="tile-box" id="puz-pool"></div>
                <button class="btn-full btn-check" onclick="Game.checkPuzzleManually()">æª¢æŸ¥</button>
            </div>

        </div>
    </div>

    <!-- PAGE 4: LEARNED WORDS -->
    <div id="page-learned" class="page">
        <header>
            <div class="btn-header-icon btn-left btn-back" onclick="App.navTo('page-home')"></div>
            <div class="header-title">å­¸éå–®å­—</div>
            <div class="btn-header-icon btn-right" onclick="List.startPopQuiz(false)">T</div>
        </header>
        <div class="tab-bar">
            <div class="tab-btn active" onclick="List.filter('N5', this)">N5</div>
            <div class="tab-btn" onclick="List.filter('N4', this)">N4</div>
            <div class="tab-btn" onclick="List.filter('N3', this)">N3</div>
            <div class="tab-btn" onclick="List.filter('N2', this)">N2</div>
            <div class="tab-btn" onclick="List.filter('N1', this)">N1</div>
        </div>
        <div class="content-scroll" id="learned-list"></div>
    </div>

    <!-- PAGE 5: FAVORITES -->
    <div id="page-favorites" class="page">
        <header>
            <div class="btn-header-icon btn-left btn-back" onclick="App.navTo('page-home')"></div>
            <div class="header-title">æœ€æ„›å–®å­—</div>
            <div class="btn-header-icon btn-right" onclick="List.startPopQuiz(true)">T</div>
        </header>
        <div class="content-scroll" id="fav-list"></div>
    </div>

    <!-- PAGE 7: SETTINGS -->
    <div id="page-settings" class="page">
        <header>
            <div class="btn-header-icon btn-left btn-back" onclick="App.navTo('page-home')"></div>
            <div class="header-title">è¨­å®š</div>
        </header>
        <div class="content-scroll" style="padding:30px 24px;">
            <!-- Google Login -->
            <button id="btn-login" class="btn-full" style="background:#4285F4; color:white; margin-bottom:30px;">
                Google å¸³è™Ÿç™»å…¥
            </button>

            <!-- Volume Sliders -->
            <div class="slider-group">
                <label>èªéŸ³éŸ³é‡</label>
                <input type="range" id="vol-voice" min="0" max="1" step="0.1" onchange="Settings.save()">
            </div>
            <div class="slider-group">
                <label>éŸ³æ•ˆéŸ³é‡</label>
                <input type="range" id="vol-sfx" min="0" max="1" step="0.1" onchange="Settings.save()">
            </div>

            <!-- Voice Character Selector -->
            <div style="margin-top:35px; margin-bottom:40px;">
                <label>èªéŸ³é¸æ“‡å€</label>
                <div class="voice-grid">
                    <div class="voice-item" onclick="Settings.setRole('role_a')">
                        <div class="voice-avatar" id="avatar-role_a">A</div>
                        <div class="voice-name">Role A</div>
                    </div>
                    <div class="voice-item" onclick="Settings.setRole('role_b')">
                        <div class="voice-avatar" id="avatar-role_b">B</div>
                        <div class="voice-name">Role B</div>
                    </div>
                    <div class="voice-item" onclick="Settings.setRole('role_c')">
                        <div class="voice-avatar" id="avatar-role_c">C</div>
                        <div class="voice-name">Role C</div>
                    </div>
                </div>
            </div>

            <div style="margin-top:60px;">
                <button class="btn-full" style="background:var(--danger);" onclick="Settings.askClear()">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
            </div>
        </div>
    </div>

    <!-- MODAL: LEVEL INFO -->
    <div id="modal-level" class="modal-overlay" onclick="if(event.target===this) App.closeModal()">
        <div class="bottom-sheet">
            <h2 id="modal-title" style="margin:0 0 10px 0; font-size:22px;">JLPT N5 - L1</h2>
            <p id="modal-desc" style="color:#888; margin:0; line-height:1.5;">...</p>
            
            <div class="progress-line">
                <!-- 8 Dots -->
                <div class="p-dot" id="pd-0"></div>
                <div class="p-dot" id="pd-1"></div>
                <div class="p-dot" id="pd-2"></div>
                <div class="p-dot" id="pd-3"></div>
                <div class="p-dot" id="pd-4"></div>
                <div class="p-dot" id="pd-5"></div>
                <div class="p-dot" id="pd-6"></div>
                <div class="p-dot" id="pd-7"></div>
            </div>

            <button class="btn-full" onclick="Game.launchFromModal()">é–‹å§‹</button>
        </div>
    </div>

    <!-- MODAL: CONFIRM CLEAR -->
    <div id="modal-confirm" class="modal-overlay modal-center" onclick="if(event.target===this) document.getElementById('modal-confirm').classList.remove('show')">
        <div class="dialog-box">
            <h2 style="margin:0 0 15px 0; font-size:22px; color:var(--text-main);">âš ï¸ å±éšªæ“ä½œ</h2>
            <p style="color:#666; margin-bottom:25px; line-height:1.6;">
                ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œå°‡æœƒï¼š<br>
                1. åˆªé™¤æ‰€æœ‰å­¸ç¿’é€²åº¦<br>
                2. æ¸…ç©ºæœ€æ„›å–®å­—<br>
                3. æ¸…é™¤ App å¿«å–èˆ‡å¸³è™Ÿé€£çµ<br>
                <b>(æ­¤å‹•ä½œç„¡æ³•å¾©åŸ)</b>
            </p>
            <div class="btn-group">
                <button class="btn-half btn-cancel" onclick="document.getElementById('modal-confirm').classList.remove('show')">å–æ¶ˆ</button>
                <button class="btn-half btn-confirm" onclick="Settings.executeClear()">ç¢ºèªæ¸…é™¤</button>
            </div>
        </div>
    </div>

</div>

<!-- FIREBASE & PWA LOGIC -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // TODO: å¡«å…¥æ‚¨çš„ Firebase Config
    const firebaseConfig = {
  apiKey: "AIzaSyDf02Afy_G7vMpHiFiMTa4p6-8icdtEXts",
  authDomain: "japanese-vocab-app-f0c17.firebaseapp.com",
  projectId: "japanese-vocab-app-f0c17",
  storageBucket: "japanese-vocab-app-f0c17.firebasestorage.app",
  messagingSenderId: "177492188811",
  appId: "1:177492188811:web:b4fb36ae2a1ceab0747e8e"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    window.FirebaseMgr = {
        user: null,
        login: async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                alert("ç™»å…¥å¤±æ•—: " + error.message);
            }
        },
        saveUserData: async (data) => {
            localStorage.setItem('jp_pro_v5', JSON.stringify(data));
            if (!auth.currentUser) return;
            try {
                await setDoc(doc(db, "users", auth.currentUser.uid), data, { merge: true });
            } catch (e) { console.error("å‚™ä»½å¤±æ•—", e); }
        },
        loadUserData: async () => {
            if (!auth.currentUser) return null;
            const docRef = doc(db, "users", auth.currentUser.uid);
            const docSnap = await getDoc(docRef);
            return docSnap.exists() ? docSnap.data() : null;
        }
    };

    onAuthStateChanged(auth, async (user) => {
        const btn = document.getElementById('btn-login');
        if (user) {
            FirebaseMgr.user = user;
            if(btn) btn.innerText = `å·²ç™»å…¥: ${user.displayName}`;
            const cloudData = await FirebaseMgr.loadUserData();
            if(cloudData) {
                window.App.state = cloudData;
                alert("å·²è¼‰å…¥é›²ç«¯é€²åº¦ï¼Œå³å°‡é‡æ–°æ•´ç†...");
                location.reload();
            }
        } else {
            if(btn) btn.innerText = "Google å¸³è™Ÿç™»å…¥";
        }
    });

    const loginBtn = document.getElementById('btn-login');
    if(loginBtn) loginBtn.addEventListener('click', FirebaseMgr.login);

    // --- SW Registration Fix ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
            // Check for unsupported protocols
            if (window.location.protocol === 'file:' || window.location.protocol === 'data:' || window.location.href.startsWith('blob:')) {
                console.warn('Service Worker registration skipped: Unsupported protocol (file/data/blob). This is expected in preview environments.');
                return;
            }

            try {
                const registration = await navigator.serviceWorker.register('./sw.js');
                console.log('SW Registered:', registration.scope);
            } catch (err) {
                console.log('SW Registration failed:', err);
            }
        });
    }

    // ç•¶ç”¨æˆ¶åˆ‡æ›è§’è‰²æ™‚å‘¼å« (é è¼‰å…¥éŸ³æª”)
    window.preloadRoleAudio = (roleName, fileList) => {
        if (!navigator.serviceWorker.controller) return;
        const filesToCache = fileList.slice(0, 20).map(f => `/audio/${roleName}/${f}.m4a`);
        filesToCache.forEach(url => fetch(url, { priority: 'low' }).catch(() => {}));
    };

    // æ¸…é™¤èˆŠè§’è‰²å¿«å–
    window.clearRoleCache = (roleName) => {
        if (navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({ type: 'DELETE_ROLE_CACHE', role: roleName });
        }
    };
</script>

<!-- APP LOGIC -->
<script>
/* 1. DATA (Simplified for example) */
const RAW_DATA = {
    N5: [
        {k:"æµ·",h:"ã†ã¿",m:"æµ·, å¤§æµ·, æµ·æ´‹"},
        {k:"è©¦åˆ",h:"ã—ã‚ã„",m:"æ¯”è³½"},
        {k:"ãã‚Œã§ã¯",h:"ãã‚Œã§ã¯",m:"é‚£éº¼"},
        {k:"æ°—æŒã¡ãŒã„ã„",h:"ãã‚‚ã¡ãŒã„ã„",m:"èˆ’æœ, èˆ’æš¢"},
        {k:"ã¯ã˜ã‚ã«",h:"ã¯ã˜ã‚ã«",m:"é¦–å…ˆï¼Œæœ€åˆ"},
        {k:"ã‚ˆã",h:"ã‚ˆã",m:"â‘ å¥½å¥½åœ°/â‘¡ç¶“å¸¸"},
        {k:"é£›è¡Œæ©Ÿ",h:"ã²ã“ã†ã",m:"é£›æ©Ÿ"},
        {k:"ç«‹ã¡ã¾ã™",h:"ãŸã¡ã¾ã™",m:"ç«™ï¼Œç«‹"},
        {k:"æ˜ŸæœŸå¤©",h:"ã«ã¡",m:"æ˜ŸæœŸå¤©ï¼Œé€±æ—¥"},
        {k:"ã§ã¯",h:"ã§ã¯",m:"é‚£éº¼"}
    ],
    N4: [], N3: [], N2: [], N1: []
};
const LOCKED_LEVELS = ['N1', 'N2'];

/* 2. SRS LOGIC */
const SRS = {
    INTERVALS: [0.5, 1, 2, 4, 8, 16, 32],
    getStatus(record) {
        if (!record || record.streak === 0) return 'new';
        if (record.streak >= 8) return 'mastered';
        const now = Date.now();
        const lastReview = record.lastReview || 0;
        const daysRequired = this.INTERVALS[record.streak - 1];
        if (now - lastReview > daysRequired * 86400000) return 'due';
        return 'fresh';
    }
};

/* 3. APP CONTROLLER */
const App = {
    state: {
        currentMap: 'N5',
        progress: {},
        favorites: [],
        settings: { voice: 1, sfx: 1, voiceRole: 'role_a' } // Added voiceRole
    },

    init() {
        const saved = localStorage.getItem('jp_pro_v5');
        if(saved) this.state = JSON.parse(saved);
        
        // Ensure voiceRole exists
        if(!this.state.settings.voiceRole) this.state.settings.voiceRole = 'role_a';

        document.getElementById('vol-voice').value = this.state.settings.voice;
        document.getElementById('vol-sfx').value = this.state.settings.sfx;
        
        Settings.renderRoleSelection();
    },

    save() {
        if(window.FirebaseMgr) FirebaseMgr.saveUserData(this.state);
        else localStorage.setItem('jp_pro_v5', JSON.stringify(this.state));
    },

    navTo(pageId) {
        if(pageId === 'page-home') document.body.className = '';
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        if(pageId === 'page-game') this.closeModal();
    },

    openSettings() { this.navTo('page-settings'); },
    closeModal() { document.getElementById('modal-level').classList.remove('show'); },
    quitGame() {
        if(Game.source === 'map') this.navTo('page-map');
        else this.navTo('page-home');
    },

    goToMap(diff) {
        if(LOCKED_LEVELS.includes(diff)) return;
        this.state.currentMap = diff;
        document.body.className = `theme-${diff.toLowerCase()}`;
        document.getElementById('map-title').innerText = `JLPT ${diff}`;
        
        const container = document.getElementById('map-container');
        container.innerHTML = '';
        const words = RAW_DATA[diff];
        const totalLevels = Math.ceil(words.length / 10);

        for (let i = 1; i <= totalLevels; i++) {
            const key = `${diff}_L${i}`;
            const record = this.state.progress[key] || { streak: 0 };
            const status = SRS.getStatus(record);
            const btn = document.createElement('div');
            let cls = '';
            if (status === 'fresh') cls = 's-green';
            if (status === 'due') cls = 's-yellow';
            if (status === 'mastered') cls = 's-master';
            btn.className = `map-dot ${cls}`;
            btn.innerText = i;
            btn.onclick = () => this.openLevelModal(i, record, status);
            container.appendChild(btn);
        }
        this.navTo('page-map');
    },

    openLevelModal(level, record, status) {
        Game.targetLevel = level;
        Game.source = 'map';
        Game.startStatus = status;
        document.getElementById('modal-title').innerText = `JLPT ${this.state.currentMap} - L${level}`;
        
        let msg = status === 'new' ? "" : 
                  status === 'due' ? "è¤‡ç¿’æ™‚é–“åˆ°äº†ï¼(é€šé—œå¢åŠ é€²åº¦)" : 
                  status === 'fresh' ? "è¨˜æ†¶çŒ¶æ–° (é€šé—œä¸å¢åŠ é€²åº¦)" : "å·²ç²¾é€šå¤§å¸«";
        document.getElementById('modal-desc').innerText = msg;
        document.querySelector('#modal-level .btn-full').innerText = status === 'new' ? "é–‹å§‹å­¸ç¿’" : "é–‹å§‹æ¸¬é©—";

        for(let i=0; i<8; i++) {
            const dot = document.getElementById(`pd-${i}`);
            dot.className = 'p-dot';
            if (record.streak > i) dot.classList.add('done');
            else if (status === 'due' && record.streak === i) dot.classList.add('filled');
        }
        document.getElementById('modal-level').classList.add('show');
    },

    goToLearned() {
        this.navTo('page-learned');
        List.filter('N5', document.querySelector('.tab-btn')); 
    },

    goToFavorites() {
        this.navTo('page-favorites');
        List.renderFavorites();
    }
};

/* 4. LIST & FAVORITES */
const List = {
    currentFilter: 'N5',
    filter(diff, btn) {
        this.currentFilter = diff;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        
        const container = document.getElementById('learned-list');
        container.innerHTML = '';
        let displayWords = [];
        
        const allWords = RAW_DATA[diff];
        if (!allWords) {
            container.innerHTML = '<div style="text-align:center; padding:40px; color:#aaa;">å°šç„¡è³‡æ–™</div>';
            return;
        }
        const maxLevel = Math.ceil(allWords.length / 10);
        for(let i=1; i<=maxLevel; i++) {
            const key = `${diff}_L${i}`;
            if (App.state.progress[key] && App.state.progress[key].streak > 0) {
                const start = (i-1)*10;
                displayWords = displayWords.concat(allWords.slice(start, start + 10));
            }
        }

        if(displayWords.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:40px; color:#aaa;">å°šç„¡è³‡æ–™</div>';
            return;
        }
        displayWords.forEach(w => container.appendChild(this.createItem(diff, w)));
    },

    renderFavorites() {
        const container = document.getElementById('fav-list');
        container.innerHTML = '';
        if (App.state.favorites.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:40px; color:#aaa;">æš«ç„¡æœ€æ„›å–®å­—</div>';
            return;
        }
        App.state.favorites.forEach(favKey => {
            const [diff, h] = favKey.split('_'); 
            let wordObj = RAW_DATA[diff] ? RAW_DATA[diff].find(w => w.h === h) : null;
            if(wordObj) container.appendChild(this.createItem(diff, wordObj));
        });
    },

    createItem(diff, w) {
        const div = document.createElement('div');
        div.className = 'word-list-item';
        const key = `${diff}_${w.h}`;
        const isFav = App.state.favorites.includes(key);
        div.innerHTML = `
            <div>
                <div style="font-weight:bold; font-size:18px; color:#333;">${w.k || w.h}</div>
                <div style="font-size:13px; color:#888;">${w.h} ${w.m}</div>
            </div>
            <div class="heart-icon ${isFav ? 'active' : ''}" data-key="${key}" onclick="List.toggleHeart('${diff}', '${w.h}', this)">â™¥</div>
        `;
        div.children[0].onclick = () => AudioSys.playVoice(w.h);
        return div;
    },

    toggleHeart(diff, h, el) {
        const key = `${diff}_${h}`;
        const idx = App.state.favorites.indexOf(key);
        if (idx === -1) App.state.favorites.push(key);
        else App.state.favorites.splice(idx, 1);
        App.save();
        document.querySelectorAll(`.heart-icon[data-key="${key}"]`).forEach(icon => {
             if (App.state.favorites.includes(key)) icon.classList.add('active');
             else icon.classList.remove('active');
        });
        // Remove from list if in favorites page
        if(idx !== -1 && document.getElementById('page-favorites').classList.contains('active')) {
            List.renderFavorites(); 
        }
    },

    startPopQuiz(onlyFav = false) {
        let pool = [];
        if (onlyFav) {
             App.state.favorites.forEach(favKey => {
                const [diff, h] = favKey.split('_');
                let w = RAW_DATA[diff] ? RAW_DATA[diff].find(x => x.h === h) : null;
                if(w) pool.push(w);
             });
        } else {
             const diff = this.currentFilter;
             const allWords = RAW_DATA[diff];
             if(allWords) {
                 const maxLevel = Math.ceil(allWords.length / 10);
                 for(let i=1; i<=maxLevel; i++) {
                     const key = `${diff}_L${i}`;
                     if(App.state.progress[key] && App.state.progress[key].streak > 0) {
                         pool = pool.concat(allWords.slice((i-1)*10, i*10));
                     }
                 }
             }
        }
        if(pool.length < 5) {
            alert("å–®å­—é‡ä¸è¶³ (è‡³å°‘ 5 å€‹)");
            return;
        }
        pool.sort(() => Math.random() - 0.5);
        Game.startCustom(pool.slice(0, 10), 'random');
    }
};

/* 6. GAME ENGINE */
const Game = {
    queue: [], idx: 0, currentWord: null, targetLevel: 1, startStatus: 'new', source: '',

    launchFromModal() { Game.initLevel(); },

    initLevel() {
        const diff = App.state.currentMap;
        const start = (this.targetLevel - 1) * 10;
        const words = RAW_DATA[diff].slice(start, start + 10);
        if (words.length === 0) return;
        const showPreview = (this.startStatus === 'new');
        this.setupGame(words, showPreview);
    },

    startCustom(words, mode) {
        this.source = mode;
        this.setupGame(words, false);
    },

    setupGame(words, showPreview) {
        let q = [];
        if (showPreview) words.forEach(w => q.push({ type: 'preview', w: w }));
        let quizItems = [];
        words.forEach(w => {
            quizItems.push({ type: 'quiz', mode: 'jp_cn', w: w }); // æ—¥æ–‡ -> ä¸­æ–‡
            quizItems.push({ type: 'quiz', mode: 'cn_jp', w: w }); // ä¸­æ–‡ -> æ—¥æ–‡
            quizItems.push({ type: 'quiz', mode: 'audio_jp', w: w }); // è½éŸ³ -> æ—¥æ–‡ (New Mode)
            quizItems.push({ type: 'puzzle', w: w }); // æ‹¼å­—
        });
        quizItems.sort(() => Math.random() - 0.5);
        this.queue = [...q, ...quizItems];
        this.idx = 0;
        App.navTo('page-game');
        this.renderStep();
    },

    renderStep() {
        if (this.idx >= this.queue.length) { this.finish(); return; }
        const task = this.queue[this.idx];
        this.currentWord = task.w;
        document.getElementById('game-progress').innerText = `${this.idx + 1} / ${this.queue.length}`;
        
        ['view-preview', 'view-quiz', 'view-puzzle'].forEach(id => document.getElementById(id).style.display = 'none');
        this.currentDiff = App.state.currentMap; 

        setTimeout(() => AudioSys.playVoice(task.w.h), 400);

        if (task.type === 'preview') {
            document.getElementById('view-preview').style.display = 'block';
            document.getElementById('pre-kanji').innerText = task.w.k || task.w.h;
            document.getElementById('pre-kana').innerText = task.w.h;
            document.getElementById('pre-mean').innerText = task.w.m;
            this.syncHeartUI('pre-heart');

        } else if (task.type === 'quiz') {
            document.getElementById('view-quiz').style.display = 'block';
            this.syncHeartUI('quiz-heart');
            
            const isJpCn = task.mode === 'jp_cn';
            const isAudio = task.mode === 'audio_jp';

            // è¨­å®šé¡Œç›®å…§å®¹
            if (isAudio) {
                // è½éŸ³è¾¨ç¾©æ¨¡å¼ï¼šé¡¯ç¤ºå¤§å–‡å­
                document.getElementById('quiz-q-content').innerHTML = '<span style="font-size:60px; cursor:pointer;" onclick="AudioSys.playVoice(\'' + task.w.h + '\')">ğŸ”Š</span>';
                document.getElementById('quiz-q-sub').innerText = ""; 
            } else {
                // æ–‡å­—æ¨¡å¼
                document.getElementById('quiz-q-content').innerText = isJpCn ? (task.w.k || task.w.h) : task.w.m;
                // ç§»é™¤ä¸­é¸æ—¥æ¨¡å¼çš„æç¤ºæ–‡å­—
                document.getElementById('quiz-q-sub').innerText = ""; 
            }

            const box = document.getElementById('quiz-options');
            box.innerHTML = '';
            
            // è¨­å®šæ­£ç¢ºç­”æ¡ˆèˆ‡é¸é …æ± 
            // è‹¥é¡Œç›®æ˜¯æ—¥æ–‡(jp_cn)ï¼Œç­”æ¡ˆæ˜¯ä¸­æ–‡(m)
            // è‹¥é¡Œç›®æ˜¯ä¸­æ–‡(cn_jp)æˆ–è½åŠ›(audio_jp)ï¼Œç­”æ¡ˆæ˜¯æ—¥æ–‡(k/h)
            let correctVal = isJpCn ? task.w.m : (task.w.k || task.w.h);
            
            let opts = [correctVal];
            let pool = RAW_DATA[this.currentDiff] || RAW_DATA['N5'];
            
            while(opts.length < 4) {
                const r = pool[Math.floor(Math.random() * pool.length)];
                if(!r) break;
                // å¹²æ“¾é …é¡å‹éœ€èˆ‡ç­”æ¡ˆä¸€è‡´
                const val = isJpCn ? r.m : (r.k || r.h);
                if (!opts.includes(val)) opts.push(val);
            }
            opts.sort(() => Math.random() - 0.5);

            opts.forEach(o => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.innerText = o;
                const checkVal = correctVal; // Closure capture
                btn.onclick = () => this.checkQuiz(btn, o === checkVal);
                box.appendChild(btn);
            });

        } else if (task.type === 'puzzle') {
            document.getElementById('view-puzzle').style.display = 'block';
            this.syncHeartUI('puz-heart');
            document.getElementById('puz-mean').innerText = task.w.m;
            // æ‹¼å­—é—œå¡ï¼šç§»é™¤æ—¥æ–‡æç¤ºï¼Œä¿æŒç©ºç™½
            document.getElementById('puz-kanji').innerText = ""; 
            this.setupPuzzleLogic();
        }
    },

    next() { this.idx++; this.renderStep(); },

    checkQuiz(btn, isCorrect) {
        if(btn.style.pointerEvents === 'none') return;
        document.querySelectorAll('.option-btn').forEach(b => b.style.pointerEvents = 'none');
        if (isCorrect) {
            btn.classList.add('correct');
            AudioSys.playSfx('correct');
            setTimeout(() => this.next(), 600);
        } else {
            btn.classList.add('wrong');
            AudioSys.playSfx('wrong');
            if(navigator.vibrate) navigator.vibrate(200);
            setTimeout(() => {
                btn.classList.remove('wrong');
                document.querySelectorAll('.option-btn').forEach(b => b.style.pointerEvents = 'auto');
            }, 800);
        }
    },

    setupPuzzleLogic() {
        this.userTiles = [];
        let chars = this.currentWord.h.split('');
        const noise = "ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããªã«ã¬ã­ã®";
        while(chars.length < 8) chars.push(noise[Math.floor(Math.random()*noise.length)]);
        this.puzzleItems = chars.sort(()=>Math.random()-0.5).map((c,i)=>({id:i, c:c, used:false}));
        this.renderPuzzleUI();
    },

    renderPuzzleUI() {
        const slotBox = document.getElementById('puz-slots');
        const tileBox = document.getElementById('puz-pool');
        slotBox.innerHTML = ''; tileBox.innerHTML = '';
        this.userTiles.forEach((item, idx) => {
            const t = document.createElement('div'); t.className = 'tile in-slot'; t.innerText = item.c;
            t.onclick = () => { AudioSys.playSfx('pop'); this.userTiles.splice(idx, 1); this.puzzleItems.find(p=>p.id===item.id).used = false; this.renderPuzzleUI(); };
            slotBox.appendChild(t);
        });
        this.puzzleItems.forEach(item => {
            const t = document.createElement('div'); t.className = `tile ${item.used ? 'used':''}`; t.innerText = item.c;
            t.onclick = () => { if(item.used) return; AudioSys.playSfx('pop'); this.userTiles.push(item); item.used = true; this.renderPuzzleUI(); };
            tileBox.appendChild(t);
        });
    },

    checkPuzzleManually() {
        const current = this.userTiles.map(t=>t.c).join('');
        if (current === this.currentWord.h) {
             document.querySelectorAll('.in-slot').forEach(e => e.style.borderColor = 'var(--status-green)');
             AudioSys.playSfx('correct');
             setTimeout(() => this.next(), 600);
        } else {
             document.querySelectorAll('.in-slot').forEach(e => e.style.borderColor = 'var(--danger)');
             AudioSys.playSfx('wrong');
             if(navigator.vibrate) navigator.vibrate(200);
             setTimeout(() => document.querySelectorAll('.in-slot').forEach(e => e.style.borderColor = '#64B5F6'), 800);
        }
    },

    toggleHeart() {
        List.toggleHeart(this.currentDiff, this.currentWord.h, null);
        ['pre-heart', 'quiz-heart', 'puz-heart'].forEach(id => this.syncHeartUI(id));
    },

    syncHeartUI(id) {
        const el = document.getElementById(id);
        if(!el) return;
        const key = `${this.currentDiff}_${this.currentWord.h}`;
        if (App.state.favorites.includes(key)) el.classList.add('active');
        else el.classList.remove('active');
    },

    finish() {
        const key = `${App.state.currentMap}_L${this.targetLevel}`;
        const record = App.state.progress[key] || { streak: 0 };
        if (this.startStatus === 'new' || this.startStatus === 'due') record.streak += 1;
        record.lastReview = Date.now();
        App.state.progress[key] = record;
        App.save();
        if(Game.source !== 'random') {
            alert("ğŸ‰ é—œå¡å®Œæˆï¼");
            App.goToMap(App.state.currentMap);
        } else {
            alert("âš¡ æ¸¬é©—çµæŸï¼");
            App.quitGame();
        }
    }
};

/* 7. AUDIO SYSTEM */
const AudioSys = {
    playVoice(text) {
        if (!text || App.state.settings.voice <= 0.05) return;
        
        // TODO: æœªä¾†å¯¦é«”éŸ³æª”å¯¦ä½œé‚è¼¯
        // const role = App.state.settings.voiceRole;
        // const audio = new Audio(`/audio/${role}/${text}.m4a`);
        // audio.play();
        
        // ç›®å‰æš«ç”¨ TTS
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'ja-JP';
        u.volume = App.state.settings.voice;
        window.speechSynthesis.speak(u);
    },

    playSfx(type) {
        if (App.state.settings.sfx <= 0.05) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        const vol = App.state.settings.sfx;

        if (type === 'correct') {
            osc.frequency.setValueAtTime(600, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.2 * vol, ctx.currentTime);
            osc.start(); osc.stop(ctx.currentTime + 0.2);
        } else if (type === 'wrong') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, ctx.currentTime);
            osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.25 * vol, ctx.currentTime);
            osc.start(); osc.stop(ctx.currentTime + 0.3);
        } else if (type === 'pop') {
            osc.frequency.setValueAtTime(600, ctx.currentTime);
            gain.gain.setValueAtTime(0.05 * vol, ctx.currentTime);
            osc.start(); osc.stop(ctx.currentTime + 0.05);
        }
    }
};

/* 8. SETTINGS */
const Settings = {
    save() {
        App.state.settings.voice = parseFloat(document.getElementById('vol-voice').value);
        App.state.settings.sfx = parseFloat(document.getElementById('vol-sfx').value);
        App.save();
    },
    
    setRole(role) {
        App.state.settings.voiceRole = role;
        App.save();
        this.renderRoleSelection();
        
        // è§¸ç™¼å¿«å–æ¸…é™¤/é è¼‰é‚è¼¯ (å‡è¨­åŠŸèƒ½)
        if(window.clearRoleCache) {
            // æ¸…é™¤èˆŠè§’è‰²å¿«å–ä»¥ç¯€çœç©ºé–“ (å¯é¸)
            // window.clearRoleCache(oldRole);
        }
    },

    renderRoleSelection() {
        const current = App.state.settings.voiceRole;
        document.querySelectorAll('.voice-item').forEach(el => el.classList.remove('active'));
        
        // Find element by onclick handler is tricky, using manual ID mapping is better, 
        // but here we just rely on the onclick call setting the class in a real app or rebuilding DOM.
        // For simplicity, we just toggle styles based on ID match if we had IDs on items.
        // Let's re-render the active class based on the avatar IDs which are predictable
        ['role_a', 'role_b', 'role_c'].forEach(r => {
            const el = document.getElementById(`avatar-${r}`).parentElement;
            if(r === current) el.classList.add('active');
        });
    },

    askClear() { document.getElementById('modal-confirm').classList.add('show'); },

    async executeClear() {
        localStorage.removeItem('jp_pro_v5');
        if (window.FirebaseMgr && FirebaseMgr.user) {
            const cleanState = { currentMap: 'N5', progress: {}, favorites: {}, settings: { voice: 1, sfx: 1, voiceRole:'role_a' } };
            await FirebaseMgr.saveUserData(cleanState);
        }
        if ('caches' in window) {
            try {
                const keys = await caches.keys();
                await Promise.all(keys.map(key => caches.delete(key)));
            } catch(e) { console.log("Cache clear err", e); }
        }
        alert("è³‡æ–™å·²æ¸…é™¤ï¼Œå°‡é‡æ–°å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ã€‚");
        location.reload();
    }
};

App.init();
</script>
</body>
</html>